/**
 * 검색어 확장 유틸리티
 * 유사어, 오타, 동의어 등을 처리하여 검색 쿼리를 확장
 */

// 쇼핑 관련 유사어/동의어 사전
const SYNONYM_DICTIONARY = {
  // 주방용품
  '프라이팬': ['팬', '프라이팬', '후라이팬', '후라이팬', '냄비', '팬', '프라이팬'],
  '후라이팬': ['프라이팬', '팬', '후라이팬', '냄비', '프라이팬'],
  '냄비': ['냄비', '솥', '팬', '프라이팬', '후라이팬', '냄비'],
  '팬': ['프라이팬', '후라이팬', '냄비', '팬'],
  '솥': ['냄비', '솥'],
  '프라이팬이나': ['프라이팬', '팬', '후라이팬', '냄비'],
  '냄비나': ['냄비', '솥', '팬', '프라이팬'],
  
  // 그릇 및 식기 관련 (종류별 확장)
  '그릇': ['그릇', '믹싱볼', '접시', '면기', '우동기', '냉면기', '볼', '사발', '공기', '대접', '기', '접시'],
  '접시': ['접시', '그릇', '면기', '우동기', '냉면기', '공기', '대접'],
  '면기': ['면기', '우동기', '냉면기', '그릇', '접시', '기'],
  '우동기': ['우동기', '면기', '냉면기', '그릇', '접시', '기'],
  '냉면기': ['냉면기', '면기', '우동기', '그릇', '접시', '기'],
  '믹싱볼': ['믹싱볼', '볼', '그릇', '사발', '양푼'],
  '볼': ['볼', '믹싱볼', '그릇', '사발', '양푼'],
  '사발': ['사발', '볼', '그릇', '믹싱볼'],
  '공기': ['공기', '그릇', '접시', '대접'],
  '대접': ['대접', '그릇', '접시', '공기'],
  '기': ['면기', '우동기', '냉면기', '그릇', '접시'],
  
  // 의류
  '티셔츠': ['티셔츠', '티', '셔츠', '반팔', '상의', '옷'],
  '셔츠': ['셔츠', '티셔츠', '와이셔츠', '상의', '옷'],
  '바지': ['바지', '팬츠', '트레이닝바지', '청바지', '하의', '옷'],
  '팬츠': ['바지', '팬츠', '하의', '옷'],
  '옷': ['의류', '옷', '패션', '티셔츠', '셔츠', '바지', '팬츠', '상의', '하의', '의류'],
  '의류': ['옷', '패션', '의류', '티셔츠', '셔츠', '바지', '팬츠', '상의', '하의'],
  '상의': ['티셔츠', '셔츠', '옷', '상의', '반팔', '와이셔츠'],
  '하의': ['바지', '팬츠', '옷', '하의', '트레이닝바지', '청바지'],
  '반팔': ['티셔츠', '상의', '옷'],
  '와이셔츠': ['셔츠', '상의', '옷'],
  '청바지': ['바지', '팬츠', '하의', '옷'],
  '트레이닝바지': ['바지', '팬츠', '하의', '옷'],
  
  // 신발
  '신발': ['신발', '운동화', '구두', '슬리퍼', '스니커즈', '운동화'],
  '운동화': ['신발', '운동화', '스니커즈', '신발'],
  '구두': ['신발', '구두'],
  '슬리퍼': ['신발', '슬리퍼'],
  '스니커즈': ['운동화', '신발', '스니커즈'],
  
  // 액세서리
  '가방': ['가방', '백', '핸드백', '백팩', '토트백', '크로스백', '숄더백'],
  '백': ['가방', '백', '핸드백', '백팩'],
  '핸드백': ['가방', '백', '핸드백'],
  '백팩': ['가방', '백', '백팩'],
  '모자': ['모자', '캡', '비니', '베레모', '볼캡', '야구모자'],
  '캡': ['모자', '캡', '볼캡', '야구모자'],
  '비니': ['모자', '비니'],
  '베레모': ['모자', '베레모'],
  '시계': ['시계', '워치'],
  '워치': ['시계', '워치'],
  
  // 장갑 및 양말
  '장갑': ['장갑', '글로브', '핑거리스장갑'],
  '양말': ['양말', '삭스', '스타킹'],
  '삭스': ['양말', '삭스'],
  '스타킹': ['양말', '스타킹'],
  
  // 수건/타월
  '수건': ['수건', '타월', '행주', '손수건'],
  '타월': ['수건', '타월', '비치타월', '목욕수건'],
  '행주': ['수건', '행주'],
  
  // 주방용품 추가
  '조리도구': ['프라이팬', '냄비', '팬', '솥', '주방용품'],
  '컵': ['컵', '머그', '텀블러', '물컵', '커피컵'],
  '머그': ['컵', '머그', '텀블러'],
  '텀블러': ['컵', '머그', '텀블러'],
  '수저': ['수저', '숟가락', '젓가락', '포크', '나이프', '스푼'],
  '숟가락': ['수저', '숟가락', '스푼'],
  '젓가락': ['수저', '젓가락'],
  '포크': ['수저', '포크'],
  '주방용품': ['프라이팬', '냄비', '팬', '그릇', '접시', '컵', '수저'],
  
  // 전자제품
  '폰': ['핸드폰', '스마트폰', '휴대폰', '폰', '아이폰', '전자제품'],
  '스마트폰': ['핸드폰', '스마트폰', '휴대폰', '폰', '아이폰'],
  '핸드폰': ['핸드폰', '스마트폰', '휴대폰', '폰'],
  '휴대폰': ['핸드폰', '스마트폰', '휴대폰', '폰'],
  '아이폰': ['폰', '스마트폰', '핸드폰'],
  '노트북': ['노트북', '랩탑', '컴퓨터', 'PC'],
  '컴퓨터': ['컴퓨터', 'PC', '노트북', '랩탑'],
  'PC': ['컴퓨터', 'PC', '노트북'],
  '랩탑': ['노트북', '랩탑', '컴퓨터'],
  
  // 생활용품
  '비누': ['비누', '세안비누', '바디비누', '세제'],
  '세제': ['세제', '비누', '세안제'],
  '샴푸': ['샴푸', '린스', '헤어제품'],
  '린스': ['샴푸', '린스', '컨디셔너'],
  '치약': ['치약', '칫솔', '구강용품'],
  '칫솔': ['치약', '칫솔', '구강용품'],
  '로션': ['로션', '크림', '스킨케어'],
  '크림': ['로션', '크림', '스킨케어'],
  
  // 침구/홈데코
  '침대': ['침대', '매트리스', '침구'],
  '매트리스': ['침대', '매트리스'],
  '이불': ['이불', '침구', '담요'],
  '담요': ['이불', '담요', '침구'],
  '베개': ['베개', '침구', '쿠션'],
  '쿠션': ['베개', '쿠션', '방석'],
  '침구': ['이불', '베개', '침대', '매트리스', '담요'],
  '커튼': ['커튼', '블라인드', '차광'],
  '블라인드': ['커튼', '블라인드'],
  '러그': ['러그', '카펫', '매트'],
  '카펫': ['러그', '카펫', '매트'],
  
  // 청소용품
  '청소': ['청소용품', '걸레', '빗자루', '청소기'],
  '청소용품': ['걸레', '빗자루', '청소기', '청소'],
  '걸레': ['청소용품', '걸레', '청소'],
  '빗자루': ['청소용품', '빗자루', '청소'],
  '청소기': ['청소용품', '청소기', '청소'],
  '휴지': ['휴지', '화장지', '티슈'],
  '화장지': ['휴지', '화장지', '티슈'],
  '티슈': ['휴지', '화장지', '티슈'],
  
  // 수납/정리
  '수납': ['수납', '정리', '박스', '바구니', '서랍'],
  '정리': ['수납', '정리', '박스', '바구니'],
  '박스': ['수납', '박스', '정리'],
  '바구니': ['수납', '바구니', '정리'],
  '서랍': ['수납', '서랍', '정리'],
  
  // 기타
  '책': ['도서', '책', '서적'],
  '도서': ['책', '도서', '서적'],
  '서적': ['책', '도서', '서적'],
  '음악': ['음악', '노래', '음반'],
  '노래': ['음악', '노래', '음반'],
  '음반': ['음악', '노래', '음반'],
  
  // 캠핑/야외
  '캠핑': ['캠핑', '야외', '텐트', '매트', '랜턴'],
  '야외': ['캠핑', '야외', '텐트'],
  '텐트': ['캠핑', '텐트', '야외'],
  '랜턴': ['캠핑', '랜턴', '야외'],
  
  // 반려동물
  '반려동물': ['반려동물', '펫', '강아지', '고양이'],
  '펫': ['반려동물', '펫'],
  '강아지': ['반려동물', '펫', '강아지'],
  '고양이': ['반려동물', '펫', '고양이'],
};


/**
 * 단순 오타 변형 생성 (일반적인 오타 패턴)
 * 실제로는 유사어 사전과 부분 매칭이 더 효과적이므로 최소한만 처리
 */
function generateTypoVariations(word, maxVariations = 2) {
  const variations = new Set();
  
  if (word.length === 0 || word.length < 2) return [];
  
  // 일반적인 오타: 같은 발음의 다른 표기 (예: 후라이팬/프라이팬)
  // 이는 유사어 사전에서 처리되므로 여기서는 간단한 변형만
  
  // 1. 한 글자 누락 (단어가 3글자 이상일 때만)
  if (word.length >= 3 && variations.size < maxVariations) {
    for (let i = 1; i < word.length - 1 && variations.size < maxVariations; i++) {
      const variation = word.substring(0, i) + word.substring(i + 1);
      if (variation.length >= 2) {
        variations.add(variation);
      }
    }
  }
  
  return Array.from(variations);
}

/**
 * 유사어/동의어 확장
 */
function expandSynonyms(word) {
  const synonyms = new Set([word]);
  
  // 사전에서 찾기
  const lowerWord = word.toLowerCase();
  if (SYNONYM_DICTIONARY[lowerWord]) {
    SYNONYM_DICTIONARY[lowerWord].forEach(syn => synonyms.add(syn));
  }
  
  // 부분 매칭 (예: "프라이팬"에서 "팬" 추출)
  Object.keys(SYNONYM_DICTIONARY).forEach(key => {
    if (word.includes(key) || key.includes(word)) {
      SYNONYM_DICTIONARY[key].forEach(syn => synonyms.add(syn));
    }
  });
  
  return Array.from(synonyms);
}

/**
 * 검색어 확장 (유사어 + 오타 변형)
 */
function expandSearchQuery(query) {
  const expanded = new Set([query.trim()]);
  
  // 공백으로 분리된 단어별 처리
  const words = query.trim().split(/\s+/).filter(w => w.length > 0);
  
  words.forEach(word => {
    // 1. 유사어 추가
    const synonyms = expandSynonyms(word);
    synonyms.forEach(syn => expanded.add(syn));
    
    // 2. 오타 변형 추가 (단어가 2글자 이상일 때만)
    if (word.length >= 2 && word.length <= 10) {
      const typos = generateTypoVariations(word, 2);
      typos.forEach(typo => expanded.add(typo));
    }
  });
  
  // 3. 전체 쿼리 유사어 추가
  const querySynonyms = expandSynonyms(query.trim());
  querySynonyms.forEach(syn => expanded.add(syn));
  
  return Array.from(expanded);
}

/**
 * 검색 쿼리 배열 생성 (정확도 순서)
 */
function generateSearchQueries(originalQuery) {
  const queries = [];
  const expanded = expandSearchQuery(originalQuery);
  
  // 1. 원본 (최우선)
  queries.push({
    query: originalQuery.trim(),
    weight: 1.0,
    type: 'original',
  });
  
  // 2. 확장된 검색어들 (유사도에 따라 가중치 다르게)
  expanded.forEach(expandedQuery => {
    if (expandedQuery !== originalQuery.trim()) {
      // 유사어는 높은 가중치, 오타는 낮은 가중치
      const isSynonym = SYNONYM_DICTIONARY[expandedQuery.toLowerCase()] !== undefined;
      queries.push({
        query: expandedQuery,
        weight: isSynonym ? 0.85 : 0.75,
        type: isSynonym ? 'synonym' : 'typo',
      });
    }
  });
  
  return queries;
}

module.exports = {
  expandSearchQuery,
  generateSearchQueries,
  expandSynonyms,
  generateTypoVariations,
  SYNONYM_DICTIONARY,
};

const mongoose = require('mongoose');
const Product = require('../src/models/product');
require('dotenv').config();

// ì¹´í…Œê³ ë¦¬ë³„ multiplier ë§¤í•‘ (ì¹´í…Œê³ ë¦¬ ë¬¸ìì—´ í¬í•¨ ë§¤ì¹­)
function getCategoryMultiplier(categoryPathText) {
  if (!categoryPathText || typeof categoryPathText !== 'string') {
    return 2.10; // ê¸°ë³¸ê°’
  }

  const categoryPath = categoryPathText.trim();

  // 1.65 (ìœ ì…í˜• A)
  const multiplier165 = [
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ë„êµ¬ > ê±´ì§€ê¸°/ë§',
    'ìƒí™œì¡í™” > ì¼íšŒìš©í’ˆ > ë¹„ë‹ë´‰íˆ¬/ë¹„ë‹ì¥ê°‘/ì§€í¼ë°±',
    'ìƒí™œì¡í™” > ì¼íšŒìš©í’ˆ > ë¬¼í‹°ìŠˆ/í‹°ìŠˆ',
    'ìƒí™œì¡í™” > ì¼íšŒìš©í’ˆ > ì¼íšŒìš©ì‹ê¸°',
    'ìƒí™œì¡í™” > ì¼íšŒìš©í’ˆ > ì¼íšŒìš©ë””ìŠ¤íœì„œ',
    'ìƒí™œì¡í™” > ì¼íšŒìš©í’ˆ > ì¼íšŒìš©ì»µ',
    'ìƒí™œì¡í™” > ì¼íšŒìš©í’ˆ > ë©/í˜¸ì¼',
    'ìƒí™œì¡í™” > ì¼íšŒìš©í’ˆ > ì´ì‘¤ì‹œê²Œ/ë©´ë´‰/ê¼¬ì¹˜',
    'ìƒí™œì¡í™” > ì¼íšŒìš©í’ˆ > ê¸°íƒ€ìš©í’ˆ',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì„¸ì œ/ì„¬ìœ ìœ ì—°ì œ > ì£¼ë°©ìš©ì„¸ì œ',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì„¸ì œ/ì„¬ìœ ìœ ì—°ì œ > ë‹¤ìš©ë„ì„¸ì œ',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì„¸ì œ/ì„¬ìœ ìœ ì—°ì œ > ì„¸íƒìš©ì„¸ì œ'
  ];

  // 1.75 (ì£¼ë ¥í˜• B + ìš•ì‹¤ì²­ì†Œ ê· í˜•í˜• E)
  const multiplier175 = [
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ë„êµ¬ > ë„ë§ˆ',
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ë„êµ¬ > ê°€ìœ„/ì¹¼/ì¹¼ê°ˆì´',
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ë„êµ¬ > êµ­ì/ì£¼ê±±/ë’¤ì§€ê²Œ',
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ë„êµ¬ > ì±„ì¹¼/ê°•íŒ',
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ë„êµ¬ > ì ˆêµ¬/ë‹¤ì§€ê¸°',
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ë„êµ¬ > ê±°í’ˆê¸°/ì§‘ê²Œ',
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ë„êµ¬ > ê¸°íƒ€ìš©í’ˆ',
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ë„êµ¬ > ì±„ë°˜/ë°”êµ¬ë‹ˆ',
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ê¸°êµ¬ > í›„ë¼ì´íŒ¬/êµ¬ì´íŒ¬',
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ê¸°êµ¬ > ëƒ„ë¹„',
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ê¸°êµ¬ > ë‚´ì—´ëƒ„ë¹„/ëšë°°ê¸°',
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ê¸°êµ¬ > ì°œê¸°/ê³°ì†¥/ë“¤í†µ',
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ê¸°êµ¬ > ì£¼ì „ì',
    'ì£¼ë°©ìš©í’ˆ > ì¡°ë¦¬ê¸°êµ¬ > ê¸°íƒ€ìš©í’ˆ',
    'ì£¼ë°©ìš©í’ˆ > ì‹ê¸°/ìƒí™œìê¸° > ê³µê¸°/ëŒ€ì ‘/ì ‘ì‹œ',
    'ì£¼ë°©ìš©í’ˆ > ì‹ê¸°/ìƒí™œìê¸° > ì»µ/ë¨¸ê·¸/ì”',
    'ì£¼ë°©ìš©í’ˆ > ì‹ê¸°/ìƒí™œìê¸° > ìŠ¤í‘¼/í‹°ìŠ¤í‘¼',
    'ì£¼ë°©ìš©í’ˆ > ì‹ê¸°/ìƒí™œìê¸° > ìˆ˜ì €í†µ/ì¼€ì´ìŠ¤/ë°›ì¹¨',
    'ì£¼ë°©ìš©í’ˆ > ì‹ê¸°/ìƒí™œìê¸° > ìœ ì•„ì‹ê¸°',
    'ì£¼ë°©ìš©í’ˆ > ì‹ê¸°/ìƒí™œìê¸° > ë³´ì˜¨/ë³´ëƒ‰ì œí’ˆ',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì²­ì†Œìš©í’ˆ > í–‰ì£¼/ê±¸ë ˆ',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì²­ì†Œìš©í’ˆ > ë¨¼ì§€ë–¨ì´/ë¨¼ì§€ì œê±°ê¸°',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì²­ì†Œìš©í’ˆ > ë§ˆëŒ€/ë°€ëŒ€/ìœ ë¦¬ë‹¦ì´',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì²­ì†Œìš©í’ˆ > ìˆ˜ì„¸ë¯¸/ì†”',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì²­ì†Œìš©í’ˆ > íœ´ì§€í†µ/ë¶„ë¦¬ìˆ˜ê±°',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì²­ì†Œìš©í’ˆ > ë¹—ìë£¨/ì“°ë ˆë°›ì´',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì²­ì†Œìš©í’ˆ > ê¸°íƒ€ìš©í’ˆ',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì„¸íƒìš©í’ˆ > ë¹¨ë˜ì§‘ê²Œ/ë¹¨ë«ì¤„',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì„¸íƒìš©í’ˆ > ê±´ì¡°ëŒ€/ë°”êµ¬ë‹ˆ/ë‹¤ë¦¼íŒ',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì„¸íƒìš©í’ˆ > ê¸°íƒ€ì„¸íƒìš©í’ˆ',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì œìŠµ/ë°©í–¥/íƒˆì·¨ > ì œìŠµì œ',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì œìŠµ/ë°©í–¥/íƒˆì·¨ > íƒˆì·¨ì œ',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ì œìŠµ/ë°©í–¥/íƒˆì·¨ > ë°©í–¥ì œ',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ìš•ì‹¤ìš©í’ˆ > ëŒ€ì•¼/ë°”ê°€ì§€',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ìš•ì‹¤ìš©í’ˆ > ìˆ˜ê±´/íƒ€ì˜¬',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ìš•ì‹¤ìš©í’ˆ > ìš•ì‹¤ì˜ì/ë°”êµ¬ë‹ˆ',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ìš•ì‹¤ìš©í’ˆ > ìš•ì‹¤ì •ë¦¬ì†Œí’ˆ',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ìš•ì‹¤ìš©í’ˆ > ë³€ê¸°ì»¤ë²„',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ìš•ì‹¤ìš©í’ˆ > ìš•ì‹¤í™”',
    'ìš•ì‹¤/ì„¸íƒ/ì²­ì†Œ > ìš•ì‹¤ìš©í’ˆ > ë•Œë°€ì´/ìƒ¤ì›Œíƒ€ì˜¬'
  ];

  // 1.85 (ê°ë‹¨ê°€/êµ¬ì„±í˜• C)
  const multiplier185 = [
    'ì£¼ë°©ìš©í’ˆ > ë³´ê´€/ë°€íìš©ê¸° > í”Œë¼ìŠ¤í‹±ìš©ê¸°',
    'ì£¼ë°©ìš©í’ˆ > ë³´ê´€/ë°€íìš©ê¸° > ë¬¼í†µ/ë¬¼ë³‘',
    'ì£¼ë°©ìš©í’ˆ > ë³´ê´€/ë°€íìš©ê¸° > ë„ìê¸°/ìœ ë¦¬ìš©ê¸°',
    'ì£¼ë°©ìš©í’ˆ > ë³´ê´€/ë°€íìš©ê¸° > ì–‘ë…í†µ/ì†ŒìŠ¤í†µ',
    'ì£¼ë°©ìš©í’ˆ > ë³´ê´€/ë°€íìš©ê¸° > ë„ì‹œë½/ì°¬í•©',
    'ì£¼ë°©ìš©í’ˆ > ë³´ê´€/ë°€íìš©ê¸° > ìŠ¤í…ìš©ê¸°',
    'ì£¼ë°©ìš©í’ˆ > ë³´ê´€/ë°€íìš©ê¸° > ê¹€ì¹˜í†µ',
    'ì£¼ë°©ìš©í’ˆ > ë³´ê´€/ë°€íìš©ê¸° > ì•„ì´ìŠ¤íŠ¸ë ˆì´',
    'ì£¼ë°©ìš©í’ˆ > ë³´ê´€/ë°€íìš©ê¸° > ê¸°íƒ€ë³´ê´€/ë°€íìš©ê¸°',
    'ì£¼ë°©ìš©í’ˆ > ì£¼ë°©ì¡í™”/ì†Œí’ˆ > ìŸë°˜/íŠ¸ë ˆì´',
    'ì£¼ë°©ìš©í’ˆ > ì£¼ë°©ì¡í™”/ì†Œí’ˆ > ëƒ„ë¹„ë°›ì¹¨',
    'ì£¼ë°©ìš©í’ˆ > ì£¼ë°©ì¡í™”/ì†Œí’ˆ > ê¸°íƒ€ì£¼ë°©ì¡í™”',
    'ì£¼ë°©ìš©í’ˆ > ì£¼ë°©ì¡í™”/ì†Œí’ˆ > ë§/ì»¤ë²„/ëšœê»‘',
    'ì£¼ë°©ìš©í’ˆ > ì£¼ë°©ì¡í™”/ì†Œí’ˆ > ê³ ë¬´ì¥ê°‘/ì£¼ë°©ì¥ê°‘',
    'ì£¼ë°©ìš©í’ˆ > ì£¼ë°©ì¡í™”/ì†Œí’ˆ > ì»¤í”¼/í‹°',
    'ìˆ˜ë‚©/ì •ë¦¬ > ë¦¬ë¹™ë°•ìŠ¤/ë°”êµ¬ë‹ˆ > ë¦¬ë¹™ë°•ìŠ¤',
    'ìˆ˜ë‚©/ì •ë¦¬ > ë¦¬ë¹™ë°•ìŠ¤/ë°”êµ¬ë‹ˆ > ë°”êµ¬ë‹ˆ',
    'ìˆ˜ë‚©/ì •ë¦¬ > ë¦¬ë¹™ë°•ìŠ¤/ë°”êµ¬ë‹ˆ > íŒ¨ë¸Œë¦­ì •ë¦¬í•¨',
    'ìˆ˜ë‚©/ì •ë¦¬ > ì†Œí’ˆê±¸ì´/ì˜·ê±¸ì´/ì»¤ë²„ > ì»¤ë²„',
    'ìˆ˜ë‚©/ì •ë¦¬ > ì†Œí’ˆê±¸ì´/ì˜·ê±¸ì´/ì»¤ë²„ > ì†Œí’ˆê±¸ì´/í›„í¬',
    'ìˆ˜ë‚©/ì •ë¦¬ > ì†Œí’ˆê±¸ì´/ì˜·ê±¸ì´/ì»¤ë²„ > ì˜·ê±¸ì´/ë°”ì§€ê±¸ì´',
    'ìˆ˜ë‚©/ì •ë¦¬ > ì„œëì¥/ìˆ˜ë‚©í•¨ > ê¸°íƒ€ì •ë¦¬ì†Œí’ˆ',
    'ìˆ˜ë‚©/ì •ë¦¬ > ì„œëì¥/ìˆ˜ë‚©í•¨ > ë°ìŠ¤í¬ì •ë¦¬ì†Œí’ˆ',
    'ìˆ˜ë‚©/ì •ë¦¬ > ì„œëì¥/ìˆ˜ë‚©í•¨ > ë°ìŠ¤í¬ì„œëì¥',
    'ìˆ˜ë‚©/ì •ë¦¬ > ì„œëì¥/ìˆ˜ë‚©í•¨ > ëŒ€í˜•ì„œëì¥',
    'ìˆ˜ë‚©/ì •ë¦¬ > ì„ ë°˜/ì§„ì—´ëŒ€ > ë‹¤ìš©ë„ì„ ë°˜',
    'ìˆ˜ë‚©/ì •ë¦¬ > ì„ ë°˜/ì§„ì—´ëŒ€ > ì£¼ë°©ì„ ë°˜',
    'ìˆ˜ë‚©/ì •ë¦¬ > ì„ ë°˜/ì§„ì—´ëŒ€ > ìš•ì‹¤ì„ ë°˜',
    'ìˆ˜ë‚©/ì •ë¦¬ > ì„ ë°˜/ì§„ì—´ëŒ€ > ë©”íƒˆë™',
    'ì¸í…Œë¦¬ì–´ > ê±°ìš¸/ì‹œê³„/ì•¡ì > ì•¡ì',
    'ì¸í…Œë¦¬ì–´ > ê±°ìš¸/ì‹œê³„/ì•¡ì > ì‹œê³„',
    'ì¸í…Œë¦¬ì–´ > ê±°ìš¸/ì‹œê³„/ì•¡ì > íƒìƒìš©ê±°ìš¸',
    'ì¸í…Œë¦¬ì–´ > ê±°ìš¸/ì‹œê³„/ì•¡ì > ë²½ê±¸ì´/ì „ì‹ ê±°ìš¸',
    'ì¸í…Œë¦¬ì–´ > ì¸í…Œë¦¬ì–´ì†Œí’ˆ > ë² ê°œ/ë°©ì„/ë‹´ìš”',
    'ì¸í…Œë¦¬ì–´ > ì¸í…Œë¦¬ì–´ì†Œí’ˆ > ê¸°íƒ€ì†Œí’ˆ',
    'ì¸í…Œë¦¬ì–´ > ì¸í…Œë¦¬ì–´ì†Œí’ˆ > ë§ˆë¸”',
    'ì¸í…Œë¦¬ì–´ > ë§¤íŠ¸/ì¹´í˜íŠ¸ > ë§¤íŠ¸/ë°œíŒ',
    'ì¸í…Œë¦¬ì–´ > ë§¤íŠ¸/ì¹´í˜íŠ¸ > ì¹´í˜íŠ¸',
    'ì¸í…Œë¦¬ì–´ > ì»¤íŠ¼/ë¸”ë¼ì¸ë“œ > ì»¤íŠ¼',
    'ì¸í…Œë¦¬ì–´ > ì»¤íŠ¼/ë¸”ë¼ì¸ë“œ > ì»¤íŠ¼ë´‰/ë ˆì¼/ê¸°íƒ€ë¶€í’ˆ',
    'ì¸í…Œë¦¬ì–´ > ì»¤íŠ¼/ë¸”ë¼ì¸ë“œ > ë¸”ë¼ì¸ë“œ/ë¡¤ìŠ¤í¬ë¦°',
    'ì¸í…Œë¦¬ì–´ > ìŠ¤í‹°ì»¤/ì‹œíŠ¸ì§€/ë²½ì§€',
    'ì¸í…Œë¦¬ì–´ > ìŠ¤í‹°ì»¤/ì‹œíŠ¸ì§€/ë²½ì§€ > ë°ì½”ìŠ¤í‹°ì»¤',
    'ì¸í…Œë¦¬ì–´ > ìŠ¤í‹°ì»¤/ì‹œíŠ¸ì§€/ë²½ì§€ > ë²½ì§€/ì‹œíŠ¸ì§€',
    'ì¸í…Œë¦¬ì–´ > ìŠ¤í‹°ì»¤/ì‹œíŠ¸ì§€/ë²½ì§€ > ë‹¤ìš©ë„ì‹œíŠ¸ì§€',
    'ì—¬ê°€/ê±´ê°• > ì°¨ëŸ‰ìš©í’ˆ > ì„¸ì°¨/ê´€ë¦¬',
    'ì—¬ê°€/ê±´ê°• > ì°¨ëŸ‰ìš©í’ˆ > ì°¨ëŸ‰ìš©ì•¡ì„¸ì„œë¦¬',
    'ì—¬ê°€/ê±´ê°• > ì°¨ëŸ‰ìš©í’ˆ > ì°¨ëŸ‰ìš©ë°©í–¥ì œ/íƒˆì·¨ì œ',
    'ë””ì§€í„¸/ê°€ì „ > PC/ìŠ¤ë§ˆíŠ¸í° > ìŠ¤ë§ˆíŠ¸í°ìš©í’ˆ',
    'ë””ì§€í„¸/ê°€ì „ > PC/ìŠ¤ë§ˆíŠ¸í° > PCìš©í’ˆ',
    'ë””ì§€í„¸/ê°€ì „ > PC/ìŠ¤ë§ˆíŠ¸í° > ìŒí–¥ê¸°ê¸°',
    'ë””ì§€í„¸/ê°€ì „ > PC/ìŠ¤ë§ˆíŠ¸í° > ë‹¤ìš©ë„/ê¸°íƒ€ê±°ì¹˜ëŒ€',
    'ë””ì§€í„¸/ê°€ì „ > ê¸°íƒ€ìš©í’ˆ > ì¼€ì´ë¸”/ëœì„ ',
    'ë””ì§€í„¸/ê°€ì „ > ê¸°íƒ€ìš©í’ˆ > ê³µìœ ê¸°/í—ˆë¸Œ/USB',
    'ë””ì§€í„¸/ê°€ì „ > ì£¼ë°©ê°€ì „ > í™ˆë©”ì´ë“œ',
    'ë””ì§€í„¸/ê°€ì „ > ì£¼ë°©ê°€ì „ > ì¿ ì»¤/ê·¸ë¦´/íŒ¬',
    'ë””ì§€í„¸/ê°€ì „ > ìƒí™œë¯¸ìš©ê°€ì „ > ì´ë¯¸ìš©',
    'ë””ì§€í„¸/ê°€ì „ > ìƒí™œë¯¸ìš©ê°€ì „ > ìƒí™œê°€ì „'
  ];

  // ì¹´í…Œê³ ë¦¬ ê²½ë¡œ ë¬¸ìì—´ í¬í•¨ ë§¤ì¹­
  if (multiplier165.some(cat => categoryPath.includes(cat))) {
    return 1.65;
  }
  if (multiplier175.some(cat => categoryPath.includes(cat))) {
    return 1.75;
  }
  if (multiplier185.some(cat => categoryPath.includes(cat))) {
    return 1.85;
  }

  // ê¸°ë³¸ê°’ 2.10 (ê³ ë§ˆì§„ D)
  return 2.10;
}

// ê¸°ì¡´ multiplier (1.91)
const OLD_MULTIPLIER = 1.91;

// ìƒí’ˆ ê°€ê²© ì—…ë°ì´íŠ¸
async function updateProductPrices() {
  try {
    const mongoUri = process.env.MONGODB_ATLAS_URL || process.env.MONGODB_URI || 'mongodb://127.0.0.1:27017/shopping-mall-demo';
    
    console.log('ğŸ”Œ Connecting to MongoDB...');
    await mongoose.connect(mongoUri);
    console.log('âœ… Connected to MongoDB\n');

    const products = await Product.find({}).lean();
    console.log(`ğŸ“¦ Found ${products.length} products to update\n`);

    let updatedCount = 0;
    let skippedCount = 0;
    let errorCount = 0;
    const stats = {
      multiplier165: 0,
      multiplier175: 0,
      multiplier185: 0,
      multiplier210: 0,
      noCategory: 0
    };

    for (const product of products) {
      try {
        // ì¹´í…Œê³ ë¦¬ ê²½ë¡œ í™•ì¸
        const categoryPathText = product.categoryPathText || '';
        
        if (!categoryPathText || !categoryPathText.trim()) {
          console.log(`â­ï¸  Skipped (no category): ${product.name} (SKU: ${product.sku})`);
          skippedCount++;
          stats.noCategory++;
          continue;
        }

        // ì¹´í…Œê³ ë¦¬ë³„ multiplier ê°€ì ¸ì˜¤ê¸°
        const newMultiplier = getCategoryMultiplier(categoryPathText);
        
        // ê¸°ì¡´ ê°€ê²©ì—ì„œ VIP5 ì—­ì‚° (ê¸°ì¡´ multiplier ì‚¬ìš©)
        const oldPrice = product.price || 0;
        if (oldPrice <= 0) {
          console.log(`â­ï¸  Skipped (invalid price): ${product.name} (SKU: ${product.sku})`);
          skippedCount++;
          continue;
        }

        // VIP5 = oldPrice / OLD_MULTIPLIER
        const vip5 = oldPrice / OLD_MULTIPLIER;
        
        // ìƒˆë¡œìš´ ê°€ê²© ê³„ì‚°: VIP5 * newMultiplier (10ì› ë‹¨ìœ„ë¡œ ì ˆì‚­)
        const newPrice = Math.floor((vip5 * newMultiplier) / 10) * 10;
        
        // í• ì¸ìœ¨ì´ ìˆìœ¼ë©´ originalPriceë„ ì¬ê³„ì‚°
        let newOriginalPrice = null;
        const discountRate = product.discountRate || 0;
        if (discountRate > 0 && discountRate < 100) {
          // ì›ë˜ ê°€ê²© ì—­ì‚°: í˜„ì¬ ê°€ê²© / (1 - í• ì¸ìœ¨/100), 100ì› ë‹¨ìœ„ë¡œ ì ˆì‚­
          newOriginalPrice = Math.floor((newPrice / (1 - discountRate / 100)) / 100) * 100;
        }

        // ê°€ê²©ì´ ë³€ê²½ë˜ì§€ ì•Šì€ ê²½ìš° ìŠ¤í‚µ
        if (Math.abs(newPrice - oldPrice) < 1) {
          console.log(`â­ï¸  No price change: ${product.name} (SKU: ${product.sku}) - Price: ${oldPrice.toLocaleString()}ì› (Multiplier: ${newMultiplier})`);
          skippedCount++;
          continue;
        }

        // ìƒí’ˆ ì—…ë°ì´íŠ¸
        await Product.findByIdAndUpdate(
          product._id,
          {
            $set: {
              price: newPrice,
              originalPrice: newOriginalPrice
            }
          },
          { new: true, runValidators: true }
        );

        console.log(`âœ… Updated: ${product.name} (SKU: ${product.sku})`);
        console.log(`   Category: ${categoryPathText}`);
        console.log(`   Old Price: ${oldPrice.toLocaleString()}ì› â†’ New Price: ${newPrice.toLocaleString()}ì›`);
        console.log(`   Multiplier: ${OLD_MULTIPLIER} â†’ ${newMultiplier}`);
        if (newOriginalPrice) {
          console.log(`   Original Price: ${(product.originalPrice || 0).toLocaleString()}ì› â†’ ${newOriginalPrice.toLocaleString()}ì›`);
        }
        console.log('');

        updatedCount++;
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        if (newMultiplier === 1.65) stats.multiplier165++;
        else if (newMultiplier === 1.75) stats.multiplier175++;
        else if (newMultiplier === 1.85) stats.multiplier185++;
        else if (newMultiplier === 2.10) stats.multiplier210++;

      } catch (error) {
        console.error(`âŒ Error updating ${product.name} (SKU: ${product.sku}):`, error.message);
        errorCount++;
      }
    }

    console.log('\nğŸ“Š Summary:');
    console.log(`   âœ… Updated: ${updatedCount}`);
    console.log(`   â­ï¸  Skipped: ${skippedCount}`);
    console.log(`   âŒ Errors: ${errorCount}`);
    console.log('\nğŸ“ˆ Multiplier Statistics:');
    console.log(`   1.65 (ìœ ì…í˜• A): ${stats.multiplier165}`);
    console.log(`   1.75 (ì£¼ë ¥í˜• B + ìš•ì‹¤ì²­ì†Œ ê· í˜•í˜• E): ${stats.multiplier175}`);
    console.log(`   1.85 (ê°ë‹¨ê°€/êµ¬ì„±í˜• C): ${stats.multiplier185}`);
    console.log(`   2.10 (ê³ ë§ˆì§„ D - ê¸°ë³¸ê°’): ${stats.multiplier210}`);
    console.log(`   No Category: ${stats.noCategory}`);
    
    await mongoose.disconnect();
    console.log('\nâœ… Disconnected from MongoDB');
    process.exit(0);
  } catch (error) {
    console.error('âŒ Fatal error:', error);
    process.exit(1);
  }
}

updateProductPrices();


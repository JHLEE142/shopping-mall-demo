# 쇼핑몰 프로젝트 미완성 프로세스 리뷰

## 📋 개요
이 문서는 프로젝트 전체를 검토하여 완결되지 못한 프로세스와 기능을 정리한 것입니다.

---

## 🔴 일반 사용자용 - 미완성 프로세스

### 1. 주문 프로세스

#### 1.1 재고 자동 차감 ✅
- **현재 상태**: 주문 생성 시 재고가 자동으로 차감됨 (트랜잭션 포함)
- **구현 내용**:
  - `createOrder` 함수에서 주문 생성 시 각 상품의 재고 차감 (reserved 증가)
  - 재고 부족 시 주문 거부 및 에러 메시지 반환
  - MongoDB 세션을 사용한 트랜잭션 처리로 재고 차감 실패 시 주문 롤백
  - 재고 이력 자동 기록 (`InventoryHistory` 모델)
- **추가 개선 가능**:
  - 재고 부족 시 대기 처리 옵션

#### 1.2 주문 상태 자동 업데이트 ✅
- **현재 상태**: 주문 상태가 자동으로 업데이트됨
- **구현 내용**:
  - 결제 검증 완료 시 자동으로 `pending` → `paid` 상태로 변경
  - 배송 추적 번호 입력 시 자동으로 `paid` → `fulfilled` 상태로 변경
  - 배송 완료 시간 입력 시 상태 확인 및 업데이트
  - 상태 변경 시 audit log 자동 기록

#### 1.3 주문 취소 시 재고 복구 ✅
- **현재 상태**: 주문 취소 시 재고가 자동으로 복구됨 (트랜잭션 포함)
- **구현 내용**:
  - `cancelOrder` 함수에서 주문 취소 시 재고 복구 (reserved 감소)
  - 취소된 수량만큼 재고 복구
  - MongoDB 세션을 사용한 트랜잭션 처리
  - 재고 이력 자동 기록

### 2. 결제 및 환불 프로세스

#### 2.1 실제 환불 처리 ✅
- **현재 상태**: 포트원 API를 통한 실제 환불 처리가 구현됨
- **구현 내용**:
  - `cancelPortOnePayment` 함수로 포트원 API 연동하여 실제 결제 취소 처리
  - 교환/반품 승인 시 자동 환불 처리
  - 환불 완료 후 주문 상태를 `refunded`로 변경
  - 환불 금액 계산 및 처리
- **추가 개선 가능**:
  - 부분 환불 처리
  - 환불 실패 시 재시도 로직

#### 2.2 포인트 결제 연동 🟡
- **현재 상태**: 백엔드 로직은 완료되었으나 프론트엔드 UI 미구현
- **구현 내용 (백엔드)**:
  - 주문 생성 시 포인트 사용 처리 (트랜잭션 포함)
  - 포인트 사용 금액만큼 결제 금액 차감
  - 포인트 사용 내역 자동 기록 (`PointHistory`)
  - 포인트 부족 시 에러 처리
  - 주문 총액 초과 포인트 사용 방지
- **필요 작업 (프론트엔드)**:
  - 주문 페이지에 포인트 사용 UI 추가
  - 포인트 사용 입력 필드 및 최대 사용 가능 포인트 표시
  - 포인트 사용 시 주문 총액 실시간 업데이트

### 3. 배송 추적

#### 3.1 배송 추적 번호 조회 UI ❌
- **현재 상태**: 배송 추적 번호는 저장되지만 사용자가 조회할 수 있는 UI 없음
- **문제점**: 사용자가 배송 상태를 확인할 수 없음
- **필요 작업**:
  - 주문 상세 페이지에 배송 추적 번호 표시
  - 배송사 API 연동 (택배사별 추적 API)
  - 배송 상태 실시간 조회 기능

### 4. 알림 시스템

#### 4.1 주문/배송 알림 ❌
- **현재 상태**: 상품 문의 알림만 부분적으로 구현됨
- **문제점**:
  - 주문 완료 알림 없음
  - 배송 시작/완료 알림 없음
  - 주문 취소/환불 알림 없음
- **필요 작업**:
  - 이메일 알림 시스템 구축
  - SMS 알림 연동 (선택사항)
  - 주문 상태 변경 시 자동 알림 발송

---

## 🟡 관리자용 - 미완성 프로세스

### 1. 주문 관리

#### 1.1 배송 추적 번호 입력 UI ❌
- **현재 상태**: 관리자 대시보드에서 배송 추적 번호를 볼 수만 있고 입력/수정 불가
- **문제점**: 관리자가 배송 추적 번호를 업데이트할 수 없음
- **필요 작업**:
  - 주문 상세 페이지에 배송 추적 번호 입력/수정 필드 추가
  - 배송 추적 번호 입력 시 `dispatchedAt` 자동 기록
  - 배송 추적 번호 업데이트 API 연동

#### 1.2 주문 상태 일괄 변경 ❌
- **현재 상태**: 주문 상태를 하나씩만 변경 가능
- **문제점**: 여러 주문을 한 번에 처리하기 어려움
- **필요 작업**:
  - 주문 목록에서 여러 주문 선택 기능
  - 선택한 주문들의 상태 일괄 변경
  - 일괄 변경 시 audit log 기록

#### 1.3 주문 필터링 및 검색 고도화 ❌
- **현재 상태**: 기본적인 주문 목록 조회만 가능
- **문제점**: 복잡한 조건으로 주문 검색 불가
- **필요 작업**:
  - 날짜 범위 필터
  - 주문 상태별 필터
  - 고객명/주문번호 검색
  - 상품명/SKU 검색

### 2. 재고 관리

#### 2.1 재고 자동 관리 ✅
- **현재 상태**: 재고가 자동으로 관리됨
- **구현 내용**:
  - 주문 생성 시 재고 자동 차감 (reserved 증가)
  - 주문 취소 시 재고 자동 복구 (reserved 감소)
  - 재고 이력 자동 기록 (`InventoryHistory` 모델)
  - 재고 부족 시 주문 거부 및 에러 메시지
- **추가 개선 가능**:
  - 재고 부족 시 관리자 알림
  - 재고 임계값 도달 시 자동 알림
  - 재고 상태 자동 업데이트 (in-stock, low-stock, critical, out-of-stock)

#### 2.2 재고 이력 관리 ✅
- **현재 상태**: 재고 변경 이력이 자동으로 기록됨
- **구현 내용**:
  - 재고 변경 이력 모델 생성 (`InventoryHistory`)
  - 주문 생성/취소 시 재고 이력 자동 기록
  - 재고 변동 추적 가능 (이전 재고, 새 재고, 이전 예약, 새 예약)
  - 재고 변동 사유 및 담당자 기록
- **필요 작업 (프론트엔드)**:
  - 재고 이력 조회 UI (관리자 대시보드)
  - 재고 이력 필터링 및 검색 기능

### 3. 교환/반품 관리

#### 3.1 교환/반품 승인 후 자동 처리 ✅
- **현재 상태**: 교환/반품 승인 시 자동 처리가 구현됨
- **구현 내용**:
  - 교환/반품 승인 시 자동 환불 처리 (포트원 API)
  - 반품 승인 시 재고 자동 복구 (트랜잭션 포함)
  - 환불 완료 후 주문 상태를 `refunded`로 변경
  - 재고 이력 자동 기록
- **추가 개선 가능**:
  - 교환 승인 시 새 상품 주문 자동 생성
  - 부분 환불 처리

### 4. 통계 및 리포트

#### 4.1 실시간 대시보드 ❌
- **현재 상태**: 통계는 있으나 실시간 업데이트 없음
- **문제점**: 최신 데이터를 보기 위해 새로고침 필요
- **필요 작업**:
  - WebSocket 또는 Polling을 통한 실시간 업데이트
  - 실시간 주문/매출 카운터
  - 실시간 재고 알림

---

## 🟠 공통 - 미완성 프로세스

### 1. 스케줄러 및 자동화

#### 1.1 쿠폰 자동 만료 처리 ❌
- **현재 상태**: 쿠폰 만료일은 있으나 자동 만료 처리 없음
- **문제점**: 만료된 쿠폰이 계속 표시될 수 있음
- **필요 작업**:
  - Cron job으로 만료 쿠폰 자동 비활성화
  - 만료 예정 쿠폰 알림

#### 1.2 포인트 만료 처리 ❌
- **현재 상태**: 포인트 만료일 필드는 있으나 자동 만료 처리 없음
- **문제점**: 만료된 포인트가 계속 잔액에 포함될 수 있음
- **필요 작업**:
  - Cron job으로 만료 포인트 자동 차감
  - 만료 예정 포인트 알림

#### 1.3 주문 자동 취소 ❌
- **현재 상태**: 미결제 주문이 계속 남아있음
- **문제점**: 장기간 미결제 주문이 재고를 점유
- **필요 작업**:
  - 일정 시간(예: 24시간) 미결제 주문 자동 취소
  - 자동 취소 시 재고 복구

### 2. 에러 처리 및 로깅

#### 2.1 구조화된 에러 로깅 ❌
- **현재 상태**: 기본적인 console.log만 사용
- **문제점**: 에러 추적 및 디버깅 어려움
- **필요 작업**:
  - Winston 또는 Pino 같은 로깅 라이브러리 도입
  - 에러 로그 파일 저장
  - 에러 알림 시스템

#### 2.2 트랜잭션 처리 ✅
- **현재 상태**: MongoDB 세션을 사용한 트랜잭션 처리 구현됨
- **구현 내용**:
  - 주문 생성 시 재고 차감 + 주문 생성 + 쿠폰 사용 + 포인트 사용 원자적 처리
  - 주문 취소 시 재고 복구 + 주문 취소 원자적 처리
  - 교환/반품 승인 시 환불 + 재고 복구 + 주문 상태 변경 원자적 처리
  - 트랜잭션 실패 시 자동 롤백

### 3. 보안 및 검증

#### 3.1 입력 검증 강화 ❌
- **현재 상태**: 기본적인 검증만 있음
- **문제점**: 악의적인 입력에 취약
- **필요 작업**:
  - Zod 또는 Joi를 사용한 스키마 검증
  - XSS 방지
  - SQL Injection 방지 (Mongoose는 기본 방지하지만 추가 검증 필요)

#### 3.2 Rate Limiting ❌
- **현재 상태**: API 호출 제한 없음
- **문제점**: DDoS 공격에 취약
- **필요 작업**:
  - express-rate-limit 도입
  - IP별 요청 제한
  - 사용자별 요청 제한

---

## 📊 우선순위별 정리

### 🔥 긴급 (핵심 비즈니스 로직)
1. ✅ **주문 생성 시 재고 자동 차감** (완료)
2. ✅ **실제 환불 처리 (포트원 API 연동)** (완료)
3. ✅ **주문 취소 시 재고 복구** (완료)
4. ✅ **트랜잭션 처리로 데이터 일관성 보장** (완료)

### ⚠️ 중요 (사용자 경험)
5. ✅ **주문 상태 자동 업데이트** (완료)
6. ❌ **배송 추적 번호 입력/조회 UI** (미완성)
7. 🟡 **포인트 결제 연동** (백엔드 완료, 프론트엔드 필요)
8. ❌ **주문/배송 알림 시스템** (미완성)

### 📌 개선 (운영 효율성)
9. ❌ **관리자 배송 추적 번호 입력 UI** (미완성)
10. ✅ **재고 자동 관리 및 알림** (기본 기능 완료, 알림 기능 필요)
11. ❌ **쿠폰/포인트 자동 만료 처리** (미완성)
12. ❌ **주문 자동 취소 (미결제)** (미완성)
13. ❌ **구조화된 로깅 시스템** (미완성)

---

## 📝 참고사항

- 모든 미완성 프로세스는 기존 코드 구조를 최대한 활용하여 구현 가능
- 일부 기능은 외부 서비스 연동이 필요 (포트원, 택배사 API, 이메일/SMS 서비스)
- 트랜잭션 처리는 MongoDB 4.0+ 버전에서 지원하는 세션 기반 트랜잭션 사용 (구현 완료)

## 📊 구현 현황 요약

### ✅ 완료된 기능
- 재고 자동 차감 및 복구 (트랜잭션 포함)
- 주문 상태 자동 업데이트
- 실제 환불 처리 (포트원 API)
- 교환/반품 승인 시 자동 처리
- 재고 이력 관리
- 트랜잭션 처리

### 🟡 부분 완료
- 포인트 결제 연동 (백엔드 완료, 프론트엔드 UI 필요)

### ❌ 미완성 기능
- 배송 추적 번호 입력/조회 UI
- 주문/배송 알림 시스템
- 관리자 배송 추적 번호 입력 UI
- 쿠폰/포인트 자동 만료 처리
- 미결제 주문 자동 취소
- 구조화된 로깅 시스템


# 상품 등록/가격 정책 리뷰

본 문서는 현재 프로젝트의 **상품 등록(엑셀 업로드)** 로직과 **가격 정책** 로직을 재사용 가능한 형태로 정리한 리뷰 메모입니다.

---

## 1. 핵심 이슈 요약 (우선순위)

### High
- **커밋 단계에서 서버 재검증/재계산 부재**
  - `commitImport`는 `req.body.preview`의 `mapped` 값을 그대로 사용합니다.
  - 클라이언트 조작 시 가격 정책/검증을 우회할 수 있으므로 **서버 재검증 및 가격 재계산 필요**.

### Medium
- **미리보기 단계에서 SKU 전체 스캔**
  - `importExcel`에서 `Product.find({}).select('sku')` 전체 조회는 데이터 증가 시 성능 저하 가능.
  - 파일 내 SKU만 추출해 `$in` 조회로 최적화 필요.

- **카테고리별 배수 로직 미사용**
  - 카테고리별 multiplier 함수가 존재하지만 실제 가격 계산에는 사용되지 않음.
  - 운영 정책과 실제 적용 간 불일치 가능성.

- **랜덤 할인율로 마진 예측 어려움**
  - import 시 10~60% 랜덤 할인율이 적용되어 가격 정책 일관성이 약함.
  - 정책 기반/고정형 할인율로 전환 검토 필요.

---

## 2. 상품 등록(엑셀) 흐름 정리

### A. 미리보기 단계 (`importExcel`)
- 엑셀 파싱 → 행별 검증 및 매핑 → 미리보기 데이터 생성
- 파일 내 중복 SKU 체크
- DB 내 SKU 조회 후 중복 제외
- 최대 1000개 유효 상품까지 수집

### B. 커밋 단계 (`commitImport`)
- 클라이언트가 보낸 `preview` 데이터를 기준으로 insert/update 수행
- 현재는 **서버 재검증/재계산 없이** `mapped` 값을 그대로 사용
- 중복 SKU, DB 중복, 카테고리 upsert, 이미지 수집 로직 포함

---

## 3. 가격 정책 로직 요약

### 적용 규칙
- 입력 컬럼: **VIP5 = 도매가**
- 구간별 배수:
  - ≤ 10,000원 → 1.85배
  - 10,001~30,000원 → 1.45배
  - 30,001~50,000원 → 1.35배
  - ≥ 50,001원 → 1.30배
- 가격 보정:
  - 100원 단위 **올림**
  - 최소가 보정: `도매가 + 3,500원` 이상
- 할인율:
  - 10~60% 랜덤 배정
  - `originalPrice`는 할인율 역산 후 100원 올림

---

## 4. 재사용을 위한 권장 개선안

1. **commitImport에서 서버 재검증/가격 재계산 필수**
   - `mapped` 입력을 신뢰하지 말고 raw 데이터로 재계산
2. **SKU 중복 조회 최적화**
   - 전체 SKU 조회 대신 업로드 파일 내 SKU만 `$in` 쿼리
3. **카테고리별 배수 정책 정합성 정리**
   - 사용 여부 결정 후 함수 제거/활성화
4. **할인율 정책 정형화**
   - 랜덤 대신 고정/정책 기반 적용

---

## 5. 관련 코드 위치

- 상품 등록 미리보기/커밋: `server/src/controllers/productController.js`
- 가격 계산 함수: `getPriceMultiplierByWholesale`, `calculateSalePriceFromWholesale`
- (미사용) 카테고리 배수 함수: `getCategoryMultiplier`


# ì±„íŒ… ë¡œì§ ë¦¬ë·°

## ğŸ“‹ ê°œìš”

ì´ ë¬¸ì„œëŠ” smath-world í”„ë¡œì íŠ¸ì˜ ì±„íŒ… ë¡œì§ì— ëŒ€í•œ ì¢…í•©ì ì¸ ë¦¬ë·°ì…ë‹ˆë‹¤. ì±„íŒ… ì‹œìŠ¤í…œì€ RAG(Retrieval-Augmented Generation) ê¸°ë°˜ìœ¼ë¡œ êµ¬í˜„ë˜ì–´ ìˆìœ¼ë©°, ì§ˆë¬¸ ìœ í˜•ì— ë”°ë¼ ë‹¤ì–‘í•œ ì²˜ë¦¬ ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

### ì „ì²´ íë¦„

```
í”„ë¡ íŠ¸ì—”ë“œ (Chat.jsx)
    â†“
API ë¼ìš°í„° (rag.py) - POST /rag/chat
    â†“
ChatService (chat_service.py) - process_message()
    â†“
ì§ˆë¬¸ ë¶„ë¥˜ (_classify_question)
    â†“
[ë¶„ê¸°]
â”œâ”€ í†µê³„ ì§ˆë¬¸ â†’ _handle_stats_query()
â”œâ”€ ì´ìŠˆ ë¶„ì„ â†’ _handle_issue_analysis_query()
â”œâ”€ ë´‡ í™œë™ â†’ _handle_bot_activity_query()
â”œâ”€ ê³ ê° í™œë™ â†’ _handle_customer_activity_query()
â”œâ”€ ê³ ê°ì‚¬ ì •ë³´ â†’ _handle_customer_info_query()
â”œâ”€ ë¬¸ì„œ ìš”ì•½ â†’ _handle_document_summary_query()
â””â”€ ì¼ë°˜ ì§ˆë¬¸ â†’ RAGOrchestrator.run()
    â†“
RAGOrchestrator (orchestrator.py)
    â†“
â”œâ”€ Retriever.retrieve() - ë¬¸ì„œ ê²€ìƒ‰
â”‚   â”œâ”€ KBService.get_chunks_for_rag()
â”‚   â”œâ”€ EmbeddingClient.embed()
â”‚   â””â”€ VectorStore.search()
â””â”€ LLMClient.generate_answer_with_context() - ë‹µë³€ ìƒì„±
```

## âœ… ê°•ì 

### 1. **ëª…í™•í•œ ë ˆì´ì–´ ë¶„ë¦¬**
- **í”„ë¡ íŠ¸ì—”ë“œ**: UI ë° ì‚¬ìš©ì ìƒí˜¸ì‘ìš© (`Chat.jsx`)
- **API ë ˆì´ì–´**: ìš”ì²­/ì‘ë‹µ ì²˜ë¦¬ (`rag.py`)
- **ì„œë¹„ìŠ¤ ë ˆì´ì–´**: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (`ChatService`)
- **RAG ë ˆì´ì–´**: ê²€ìƒ‰ ë° ìƒì„± (`RAGOrchestrator`, `Retriever`, `LLMClient`)

### 2. **ì§€ëŠ¥ì ì¸ ì§ˆë¬¸ ë¶„ë¥˜**
`ChatService._classify_question()` ë©”ì„œë“œê°€ ì§ˆë¬¸ ìœ í˜•ì„ ìë™ìœ¼ë¡œ ë¶„ë¥˜í•˜ì—¬ ì ì ˆí•œ ì²˜ë¦¬ ë°©ì‹ì„ ì„ íƒí•©ë‹ˆë‹¤:
- **í†µê³„ ì§ˆë¬¸**: ë°ì´í„°ë² ì´ìŠ¤ ì§ì ‘ ì¡°íšŒ
- **ì´ìŠˆ ë¶„ì„**: ì‹œê°„ ê¸°ë°˜ ë¶„ì„ ë° í†µê³„
- **ë´‡/ê³ ê° í™œë™**: ì§‘ê³„ ë° ë­í‚¹
- **ë¬¸ì„œ ìš”ì•½**: RAG íŒŒì´í”„ë¼ì¸ í™œìš©
- **ì¼ë°˜ ì§ˆë¬¸**: ê¸°ë³¸ RAG ì²˜ë¦¬

### 3. **ìœ ì—°í•œ ê³ ê°ì‚¬ í•„í„°ë§**
- `client_id`ê°€ `None`ì´ë©´ ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ
- íŠ¹ì • ê³ ê°ì‚¬ ì„ íƒ ì‹œ í•´ë‹¹ ê³ ê°ì‚¬ ë°ì´í„°ë§Œ í•„í„°ë§
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ "ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤" ì˜µì…˜ ì œê³µ

### 4. **ì»¨í…ìŠ¤íŠ¸ ê°•í™”**
ê³ ê°ì‚¬ê°€ ì„ íƒëœ ê²½ìš°, ë‹¤ìŒ ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ì»¨í…ìŠ¤íŠ¸ì— ì¶”ê°€:
- ê³ ê°ì‚¬ëª…, ë‹´ë‹¹ì, ìš”ê¸ˆì œ
- ìµœê·¼ ì´ìŠˆ ì£¼ì œ (ìµœëŒ€ 5ê°œ)
- ë³´ìœ  ë¬¸ì„œ ëª©ë¡ (ìµœëŒ€ 5ê°œ)

### 5. **ì—ëŸ¬ ì²˜ë¦¬**
- ì…ë ¥ ê²€ì¦ (ë¹ˆ ë©”ì‹œì§€, ìœ íš¨í•˜ì§€ ì•Šì€ ID)
- LLM API ì‹¤íŒ¨ ì‹œ Mock ëª¨ë“œë¡œ fallback
- ì‚¬ìš©ì ì¹œí™”ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€

## âš ï¸ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„

### 1. **ì„±ëŠ¥ ì´ìŠˆ**

#### ë¬¸ì œì 
```python
# retriever.py:53-57
chunks = self.kb_service.get_chunks_for_rag(
    client_id=client_id,
    collection_id=collection_id,
    limit=2000  # ì „ì²´ ì¡°íšŒ ì‹œ ë” ë§ì€ ì²­í¬ í•„ìš”
)
```

**ë¬¸ì œ**: ë§¤ ìš”ì²­ë§ˆë‹¤ ìµœëŒ€ 2000ê°œì˜ ì²­í¬ë¥¼ ì¡°íšŒí•˜ê³  ì„ë² ë”©ì„ ìƒì„±í•©ë‹ˆë‹¤. ì´ëŠ” ë§¤ìš° ë¹„íš¨ìœ¨ì ì…ë‹ˆë‹¤.

**ì˜í–¥**:
- ì‘ë‹µ ì‹œê°„ ì§€ì—° (íŠ¹íˆ ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ ì‹œ)
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€
- ë¶ˆí•„ìš”í•œ ì„ë² ë”© ê³„ì‚°

**ê°œì„  ë°©ì•ˆ**:
1. **ë²¡í„° ì €ì¥ì†Œ ì˜êµ¬í™”**: ë§¤ ìš”ì²­ë§ˆë‹¤ ì„ë² ë”©ì„ ìƒì„±í•˜ì§€ ì•Šê³ , ì‚¬ì „ì— ì„ë² ë”©ëœ ë²¡í„°ë¥¼ ì €ì¥ì†Œì— ì €ì¥
2. **ì²­í¬ ìºì‹±**: ìì£¼ ì‚¬ìš©ë˜ëŠ” ì²­í¬ì˜ ì„ë² ë”©ì„ ìºì‹œ
3. **ì ì§„ì  ë¡œë”©**: í•„ìš”í•œ ì²­í¬ë§Œ ë™ì ìœ¼ë¡œ ë¡œë“œ

### 2. **ì§ˆë¬¸ ë¶„ë¥˜ ë¡œì§ì˜ ë³µì¡ì„±**

#### ë¬¸ì œì 
```python
# chat_service.py:255-360
def _classify_question(self, message: str) -> str:
    # 100ì¤„ì´ ë„˜ëŠ” ë³µì¡í•œ í‚¤ì›Œë“œ ë§¤ì¹­ ë¡œì§
```

**ë¬¸ì œ**: í‚¤ì›Œë“œ ê¸°ë°˜ ë¶„ë¥˜ëŠ” ìœ ì§€ë³´ìˆ˜ê°€ ì–´ë µê³ , ì˜¤ë¶„ë¥˜ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.

**ê°œì„  ë°©ì•ˆ**:
1. **LLM ê¸°ë°˜ ë¶„ë¥˜**: ê°„ë‹¨í•œ í”„ë¡¬í”„íŠ¸ë¡œ ì§ˆë¬¸ ìœ í˜•ì„ ë¶„ë¥˜
2. **ê·œì¹™ ì—”ì§„**: ë” êµ¬ì¡°í™”ëœ ê·œì¹™ ì •ì˜
3. **í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼**: í‚¤ì›Œë“œ + LLM ë¶„ë¥˜

### 3. **ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬ ë¶€ì¬**

#### ë¬¸ì œì 
```python
# rag.py:77
conversation_id = chat_message.conversation_id or str(uuid.uuid4())
```

**ë¬¸ì œ**: `conversation_id`ê°€ ìƒì„±ë˜ì§€ë§Œ ì‹¤ì œë¡œ ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ì €ì¥í•˜ê±°ë‚˜ í™œìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

**ê°œì„  ë°©ì•ˆ**:
1. **ëŒ€í™” íˆìŠ¤í† ë¦¬ ì €ì¥**: `messages` ì»¬ë ‰ì…˜ì— ì‹¤ì œ ë©”ì‹œì§€ ì €ì¥
2. **ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš°**: ìµœê·¼ Nê°œ ë©”ì‹œì§€ë¥¼ LLM ì»¨í…ìŠ¤íŠ¸ì— í¬í•¨
3. **ëŒ€í™” ìƒíƒœ ê´€ë¦¬**: ëŒ€í™” ì„¸ì…˜ë³„ ìƒíƒœ ì¶”ì 

### 4. **í•˜ë“œì½”ë”©ëœ ê°’ë“¤**

#### ë¬¸ì œì 
```python
# chat_service.py:93
.limit(5)  # ìµœê·¼ ëŒ€í™”
# chat_service.py:104
.limit(10)  # KB ë¬¸ì„œ
# chat_service.py:137
k=5  # ê²€ìƒ‰ ê²°ê³¼ ê°œìˆ˜
```

**ê°œì„  ë°©ì•ˆ**:
- ì„¤ì • íŒŒì¼ ë˜ëŠ” í™˜ê²½ ë³€ìˆ˜ë¡œ ê´€ë¦¬
- ì§ˆë¬¸ ìœ í˜•ë³„ë¡œ ë‹¤ë¥¸ ê°’ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡

### 5. **ì—ëŸ¬ ì²˜ë¦¬ ì¼ê´€ì„± ë¶€ì¡±**

#### ë¬¸ì œì 
```python
# chat_service.py:144
'conversation_id': 'temp-conversation-id'  # í–¥í›„ ì‹¤ì œ êµ¬í˜„
```

**ë¬¸ì œ**: ì„ì‹œ ê°’ì´ ì—¬ëŸ¬ ê³³ì— í•˜ë“œì½”ë”©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

**ê°œì„  ë°©ì•ˆ**:
- ì‹¤ì œ ëŒ€í™” ID ìƒì„± ë° ì €ì¥
- ë˜ëŠ” ëª…ì‹œì ìœ¼ë¡œ `None` ë°˜í™˜

### 6. **í”„ë¡ íŠ¸ì—”ë“œ ì—ëŸ¬ ì²˜ë¦¬**

#### ë¬¸ì œì 
```javascript
// Chat.jsx:69-77
catch (error) {
  console.error('Chat error:', error);
  const errorMessage = {
    // ...
    content: 'ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
  };
}
```

**ë¬¸ì œ**: ëª¨ë“  ì—ëŸ¬ì— ëŒ€í•´ ë™ì¼í•œ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.

**ê°œì„  ë°©ì•ˆ**:
- ì—ëŸ¬ íƒ€ì…ë³„ë¡œ ë‹¤ë¥¸ ë©”ì‹œì§€ í‘œì‹œ
- ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬, íƒ€ì„ì•„ì›ƒ, ì„œë²„ ì—ëŸ¬ ë“± êµ¬ë¶„

### 7. **ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§ ë¶€ì¡±**

#### ë¬¸ì œì 
- ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤
- ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ì´ ì—†ìŠµë‹ˆë‹¤

**ê°œì„  ë°©ì•ˆ**:
- êµ¬ì¡°í™”ëœ ë¡œê¹… (ì˜ˆ: `logging` ëª¨ë“ˆ ì‚¬ìš©)
- ì‘ë‹µ ì‹œê°„, í† í° ì‚¬ìš©ëŸ‰ ë“± ë©”íŠ¸ë¦­ ìˆ˜ì§‘
- ì—ëŸ¬ ì¶”ì  ì‹œìŠ¤í…œ ì—°ë™

## ğŸ”§ êµ¬ì²´ì ì¸ ê°œì„  ì œì•ˆ

### 1. ë²¡í„° ì €ì¥ì†Œ ì˜êµ¬í™”

```python
# retriever.py ê°œì„ ì•ˆ
class Retriever:
    def retrieve(self, question: str, client_id: Optional[str] = None, ...):
        # 1. ì‚¬ì „ì— ì„ë² ë”©ëœ ë²¡í„°ë¥¼ ë²¡í„° DBì—ì„œ ì¡°íšŒ
        # 2. ì§ˆë¬¸ë§Œ ì„ë² ë”©í•˜ì—¬ ìœ ì‚¬ë„ ê²€ìƒ‰
        # 3. í•„ìš”ì‹œì—ë§Œ ìƒˆë¡œìš´ ì²­í¬ ì„ë² ë”©
```

### 2. LLM ê¸°ë°˜ ì§ˆë¬¸ ë¶„ë¥˜

```python
def _classify_question_llm(self, message: str) -> str:
    prompt = f"""ë‹¤ìŒ ì§ˆë¬¸ì˜ ìœ í˜•ì„ ë¶„ë¥˜í•´ì£¼ì„¸ìš”:
    - stats: í†µê³„/ì¡°íšŒ ì§ˆë¬¸
    - issue_analysis: ì´ìŠˆ ë¶„ì„ ì§ˆë¬¸
    - bot_activity: ë´‡ í™œë™ ì§ˆë¬¸
    - customer_activity: ê³ ê° í™œë™ ì§ˆë¬¸
    - customer_info: ê³ ê°ì‚¬ ì •ë³´ ì§ˆë¬¸
    - document_summary: ë¬¸ì„œ ìš”ì•½ ì§ˆë¬¸
    - general: ì¼ë°˜ ì§ˆë¬¸
    
    ì§ˆë¬¸: {message}
    ìœ í˜•:"""
    
    response = self.llm_client.generate_answer(prompt, max_tokens=10)
    return response.strip().lower()
```

### 3. ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬

```python
def process_message(self, message: str, conversation_id: Optional[str] = None, ...):
    # ëŒ€í™” íˆìŠ¤í† ë¦¬ ì¡°íšŒ
    if conversation_id:
        history = self.message_repo.get_recent_messages(conversation_id, limit=5)
        context = self._build_conversation_context(history)
    else:
        context = None
    
    # ì»¨í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•œ ì§ˆë¬¸ ìƒì„±
    enhanced_question = self._enhance_question_with_context(message, context)
    
    # RAG ì²˜ë¦¬
    result = self.rag_orchestrator.run(enhanced_question, ...)
    
    # ë©”ì‹œì§€ ì €ì¥
    self.message_repo.save_message(conversation_id, 'user', message)
    self.message_repo.save_message(conversation_id, 'bot', result['response'])
```

### 4. ì„¤ì • ê´€ë¦¬

```python
# config.py
class ChatConfig:
    MAX_RECENT_CONVERSATIONS = 5
    MAX_KB_DOCUMENTS = 10
    DEFAULT_SEARCH_K = 5
    MAX_SEARCH_CHUNKS = 2000  # ê°œì„  í•„ìš”
```

## ğŸ“Š ì„±ëŠ¥ ìµœì í™” ìš°ì„ ìˆœìœ„

1. **ë†’ìŒ**: ë²¡í„° ì €ì¥ì†Œ ì˜êµ¬í™” (ì‘ë‹µ ì‹œê°„ ê°œì„ )
2. **ë†’ìŒ**: ì²­í¬ ì„ë² ë”© ìºì‹± (ë¹„ìš© ì ˆê°)
3. **ì¤‘ê°„**: ì§ˆë¬¸ ë¶„ë¥˜ ë¡œì§ ê°œì„  (ì •í™•ë„ í–¥ìƒ)
4. **ì¤‘ê°„**: ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬ (ì‚¬ìš©ì ê²½í—˜ ê°œì„ )
5. **ë‚®ìŒ**: ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§ (ìš´ì˜ í¸ì˜ì„±)

## ğŸ¯ ê²°ë¡ 

ì „ë°˜ì ìœ¼ë¡œ ì˜ êµ¬ì¡°í™”ëœ ì±„íŒ… ì‹œìŠ¤í…œì´ì§€ë§Œ, ì„±ëŠ¥ ìµœì í™”ì™€ ì‚¬ìš©ì ê²½í—˜ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤. íŠ¹íˆ ë²¡í„° ì €ì¥ì†Œ ì˜êµ¬í™”ëŠ” ì¦‰ì‹œ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì…ë‹ˆë‹¤.

**ì£¼ìš” ê°œì„  í¬ì¸íŠ¸**:
1. âœ… ì•„í‚¤í…ì²˜ëŠ” ëª…í™•í•˜ê³  í™•ì¥ ê°€ëŠ¥
2. âš ï¸ ì„±ëŠ¥ ìµœì í™” í•„ìš” (ë²¡í„° ì €ì¥ì†Œ ì˜êµ¬í™”)
3. âš ï¸ ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬ ì¶”ê°€ í•„ìš”
4. âš ï¸ ì§ˆë¬¸ ë¶„ë¥˜ ë¡œì§ ê°œì„  í•„ìš”

